<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Actividades Culturales Madrid</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background: #0e1726; color: #fff; padding: 20px; }
    .container { max-width: 1280px; margin: 0 auto; }
    .card { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.15); border-radius: 16px; padding: 20px; }
    .row { display: grid; gap: 20px; }
    .row.cols-2 { grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    h1 { font-size: 1.8rem; margin-bottom: 8px; }
    .muted { opacity: .8; }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px,1fr)); gap: 16px; margin: 16px 0 24px; }
    .kpi { text-align: center; padding: 16px; border-radius: 12px; background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); }
    .kpi .value { font-size: 2rem; font-weight: 700; }
    .controls { display:flex; gap:10px; align-items:center; flex-wrap: wrap; margin-top: 10px; }
    button { background: #5f6fff; color: #fff; border: none; padding: 10px 16px; border-radius: 10px; cursor: pointer; }
    button.loading { opacity: .8; animation: pulse 1.5s infinite; }
    select, input[type="date"] { background: rgba(255,255,255,.08); color: #fff; border: 1px solid rgba(255,255,255,.18); border-radius: 8px; padding: 8px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px; border-bottom: 1px solid rgba(255,255,255,.12); }
    th { text-align: left; font-size: .9rem; opacity: .9; }
    .badge { display:inline-block; padding:2px 8px; border-radius: 8px; font-size:.85rem; border:1px solid; }
    .free { background: rgba(40,167,69,.25); border-color: rgba(40,167,69,.6); }
    .paid { background: rgba(255,193,7,.25); border-color: rgba(255,193,7,.6); }
    #map { height: 420px; border-radius: 14px; border:1px solid rgba(255,255,255,.12); }
    @keyframes pulse { 0%,100%{transform:scale(1)} 50%{transform:scale(1.03)} }
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>üé≠ Dashboard Actividades Culturales Madrid</h1>
      <div class="muted">Fuente: datos.madrid.es ‚Ä¢ Cargado desde <code>latest.json</code> (mismo origen, sin CORS)</div>
      <div class="controls">
        <div id="status" class="muted">Estado: iniciando‚Ä¶</div>
        <button id="refreshBtn">üîÑ Recargar datos</button>
        <div class="muted">√öltima actualizaci√≥n local: <span id="lastUpdate">‚Äî</span></div>
      </div>
    </div>

    <div class="kpis">
      <div class="kpi"><div class="value" id="kpiTotal">0</div><div>Total eventos</div></div>
      <div class="kpi"><div class="value" id="kpiFree">0</div><div>Gratuitos</div></div>
      <div class="kpi"><div class="value" id="kpiDistricts">0</div><div>Distritos</div></div>
      <div class="kpi"><div class="value" id="kpiToday">0</div><div>Hoy</div></div>
    </div>

    <div class="row cols-2">
      <div class="card">
        <h3>üìä Eventos por distrito</h3>
        <canvas id="chartDistrict"></canvas>
      </div>
      <div class="card">
        <h3>üé≠ Tipos</h3>
        <canvas id="chartType"></canvas>
      </div>
    </div>

    <div class="row cols-2" style="margin-top:20px;">
      <div class="card">
        <h3>üó∫Ô∏è Mapa</h3>
        <div id="map"></div>
      </div>
      <div class="card">
        <h3>üìã Pr√≥ximos (20)</h3>
        <table>
          <thead><tr><th>Fecha</th><th>T√≠tulo</th><th>Lugar</th><th>Distrito</th><th>Precio</th></tr></thead>
          <tbody id="tbl"></tbody>
        </table>
      </div>
    </div>
  </div>

<script>
const SOURCE = 'latest.json'; // mismo origen
const SNAPSHOT_KEY = 'madrid_snapshot_v1';
const bust = (u) => u + (u.includes('?') ? '&' : '?') + 'v=' + Date.now();

let all = [], filtered = [];
let map, markers = [], charts = {};

const $ = (id)=>document.getElementById(id);
const setStatus = (t)=>$('status').textContent = 'Estado: ' + t;

async function fetchLatest() {
  setStatus('cargando latest.json‚Ä¶');
  const res = await fetch(bust(SOURCE), { cache: 'no-store' });
  if (!res.ok) throw new Error('HTTP ' + res.status);
  const txt = await res.text();
  try {
    const data = JSON.parse(txt);
    const graph = Array.isArray(data) ? data : data['@graph'];
    if (!Array.isArray(graph)) throw new Error('Formato inesperado');
    return graph.map(normalize);
  } catch (e) {
    throw new Error('JSON inv√°lido o 404 HTML: ' + txt.slice(0,120) + '‚Ä¶');
  }
}

function normalize(ev){
  const loc = ev.location || {};
  const addr = loc.address || {};
  const distObj = addr.district || loc.district || {};
  const distId = (distObj['@id'] || distObj.id || '').toString();
  const district = distId ? distId.split('/').pop() : (distObj.name || distObj.title || addr.district || '');
  const lat = loc.latitude ?? loc?.geo?.lat ?? loc?.geo?.latitude;
  const lon = loc.longitude ?? loc?.geo?.lon ?? loc?.geo?.longitude;
  const typeRaw = Array.isArray(ev['@type']) ? ev['@type'] : (ev['@type'] ? [ev['@type']] : []);
  const typeFirst = (typeRaw[0] || '').toString();
  const typeLabel = (typeFirst.includes('/') ? typeFirst.split('/').pop() : typeFirst).replace(/[-_]/g,' ');
  const priceStr = (ev.price ?? '').toString();
  const gratuito = (ev.free===1 || ev.free==='1' || /gratis|gratuito/i.test(priceStr)) ? 1 : 0;
  const start = ev.dtstart || ev.startDate || '';
  return {
    'TITULO': ev.title || '',
    'NOMBRE-INSTALACION': loc.title || addr['street-address'] || addr['addressLocality'] || '',
    'DISTRITO-INSTALACION': district || '‚Äî',
    'LATITUD': isFinite(Number(lat)) ? Number(lat) : null,
    'LONGITUD': isFinite(Number(lon)) ? Number(lon) : null,
    'TIPO_LABEL': typeLabel || 'Otros',
    'GRATUITO': gratuito,
    'FECHA': start,
    'FECHA_ISO': start ? new Date(start).toISOString().split('T')[0] : ''
  };
}

function saveSnapshot(){ try{ localStorage.setItem(SNAPSHOT_KEY, JSON.stringify({ts:Date.now(), data:all})) }catch{} }
function loadSnapshot(){ try{ const raw=localStorage.getItem(SNAPSHOT_KEY); if(!raw) return null; const {data}=JSON.parse(raw); return Array.isArray(data)?data:null; }catch{ return null } }

function render(){
  filtered = [...all];

  // KPIs
  $('kpiTotal').textContent = filtered.length;
  $('kpiFree').textContent = filtered.filter(e=>e.GRATUITO===1).length;
  $('kpiDistricts').textContent = new Set(filtered.map(e=>e['DISTRITO-INSTALACION']).filter(Boolean)).size;
  const today = new Date().toISOString().split('T')[0];
  $('kpiToday').textContent = filtered.filter(e=>e.FECHA_ISO===today).length;

  // Charts
  Object.values(charts).forEach(c=>{try{c.destroy()}catch{}});
  const ctxD = document.getElementById('chartDistrict').getContext('2d');
  const byDist = {}; filtered.forEach(e=>byDist[e['DISTRITO-INSTALACION']] = (byDist[e['DISTRITO-INSTALACION']]||0)+1);
  const distTop = Object.entries(byDist).sort((a,b)=>b[1]-a[1]).slice(0,10);
  charts.d = new Chart(ctxD, { type:'bar', data:{ labels: distTop.map(d=>d[0]), datasets:[{ label:'Eventos', data: distTop.map(d=>d[1]) }] }, options:{ plugins:{legend:{display:false}} } });

  const ctxT = document.getElementById('chartType').getContext('2d');
  const byType = {}; filtered.forEach(e=>byType[e['TIPO_LABEL']] = (byType[e['TIPO_LABEL']]||0)+1);
  const typeTop = Object.entries(byType).sort((a,b)=>b[1]-a[1]).slice(0,8);
  charts.t = new Chart(ctxT, { type:'doughnut', data:{ labels: typeTop.map(t=>t[0]), datasets:[{ data: typeTop.map(t=>t[1]) }] } });

  // Map
  if (!map) {
    map = L.map('map').setView([40.4168, -3.7038], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
  }
  (markers||[]).forEach(m=>map.removeLayer(m)); markers = [];
  filtered.forEach(e=>{
    if(e.LATITUD!=null && e.LONGITUD!=null){
      const m = L.marker([e.LATITUD, e.LONGITUD]).bindPopup(`<strong>${e.TITULO}</strong><br>${e['NOMBRE-INSTALACION']||'‚Äî'}<br>${e.FECHA?new Date(e.FECHA).toLocaleDateString('es-ES'):'‚Äî'}<br>${e.GRATUITO===1?'üÜì Gratis':'üí∞ Precio'}`);
      m.addTo(map); markers.push(m);
    }
  });

  // Table
  const tbody = $('tbl'); tbody.innerHTML='';
  filtered.filter(e=>e.FECHA).sort((a,b)=> new Date(a.FECHA) - new Date(b.FECHA)).slice(0,20).forEach(e=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${e.FECHA?new Date(e.FECHA).toLocaleDateString('es-ES'):'‚Äî'}</td>
                    <td>${e.TITULO||'‚Äî'}</td>
                    <td>${e['NOMBRE-INSTALACION']||'‚Äî'}</td>
                    <td>${e['DISTRITO-INSTALACION']||'‚Äî'}</td>
                    <td><span class="badge ${e.GRATUITO===1?'free':'paid'}">${e.GRATUITO===1?'Gratis':'Precio'}</span></td>`;
    tbody.appendChild(tr);
  });
}

async function loadData(){
  try {
    all = await fetchLatest();
    setStatus('ok (latest.json)');
    $('lastUpdate').textContent = new Date().toLocaleString('es-ES');
    saveSnapshot();
    render();
  } catch (e) {
    console.error(e);
    setStatus('error leyendo latest.json: ' + e.message);
    const snap = loadSnapshot();
    if (snap) { all = snap; render(); }
  }
}

document.getElementById('refreshBtn').addEventListener('click', async (ev)=>{
  const btn = ev.currentTarget; btn.classList.add('loading'); btn.disabled = true;
  try { await loadData(); } finally { btn.classList.remove('loading'); btn.disabled = false; }
});

document.addEventListener('DOMContentLoaded', loadData);
</script>
</body>
</html>
