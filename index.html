<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard Actividades Culturales Madrid</title>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh; padding: 20px; color: #fff;
    }
    .dashboard-container { max-width: 1600px; margin: 0 auto; }
    .header {
      background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      border-radius: 20px; padding: 30px; margin-bottom: 30px;
      border: 1px solid rgba(255,255,255,0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }
    .header h1 {
      font-size: 2.2rem; margin-bottom: 10px;
      background: linear-gradient(90deg, #fff, #f0f0f0);
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .update-info { display:flex; justify-content:space-between; align-items:center; margin-top:20px; flex-wrap:wrap; gap:15px; }
    .last-update { font-size: .9rem; opacity:.9; }
    .update-btn {
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      color: white; padding: 10px 20px; border-radius:10px; cursor:pointer; font-size:1rem; transition: all .3s;
    }
    .update-btn.loading { animation: pulse 1.5s infinite; }
    .kpi-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap:20px; margin-bottom:30px; }
    .kpi-card {
      background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      border-radius: 15px; padding: 25px; text-align:center; border:1px solid rgba(255,255,255,0.2);
    }
    .kpi-value {
      font-size: 2.6rem; font-weight: bold; margin: 10px 0;
      background: linear-gradient(90deg, #ffd700, #ffed4e); -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .kpi-label { font-size:1rem; opacity:.9; text-transform:uppercase; letter-spacing:1px; }
    .filters-container {
      background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      border-radius: 15px; padding: 20px; margin-bottom: 30px; border: 1px solid rgba(255,255,255,0.2);
    }
    .filters-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; }
    .filter-group { display:flex; flex-direction:column; }
    .filter-group label { margin-bottom:8px; font-weight:500; opacity:.9; }
    .filter-group select, .filter-group input {
      padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1); color:white; font-size:1rem; transition: all .3s;
    }
    .charts-container { display:grid; grid-template-columns: repeat(auto-fit, minmax(420px,1fr)); gap:30px; margin-bottom:30px; }
    .chart-card {
      background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      border-radius: 15px; padding:25px; border:1px solid rgba(255,255,255,0.2);
    }
    #map { height:500px; border-radius:15px; margin-bottom:30px; border:1px solid rgba(255,255,255,0.2); }

    .events-table-container {
      background: rgba(255,255,255,0.1); backdrop-filter: blur(10px);
      border-radius: 15px; padding: 25px; border:1px solid rgba(255,255,255,0.2); overflow-x:auto;
    }
    .events-table { width:100%; border-collapse: collapse; }
    .events-table th, .events-table td { padding:12px; text-align:left; border-bottom:1px solid rgba(255,255,255,0.1); }
    .events-table th { background: rgba(255,255,255,0.1); font-weight:600; text-transform:uppercase; font-size:.9rem; letter-spacing:1px; }
    .badge { display:inline-block; padding:4px 8px; border-radius:5px; font-size:.85rem; font-weight:500; }
    .badge.free { background: rgba(76,175,80,0.3); border: 1px solid rgba(76,175,80,0.5); }
    .badge.paid { background: rgba(255,152,0,0.3); border: 1px solid rgba(255,152,0,0.5); }

    .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display:flex; justify-content:center; align-items:center; z-index:9999; }
    .loading-spinner { width:60px; height:60px; border:4px solid rgba(255,255,255,0.3); border-top-color:white; border-radius:50%; animation: spin 1s linear infinite; }
    .status { margin-left: 10px; font-size: .9rem; padding: 4px 8px; border-radius: 8px; background: rgba(255,255,255,.15); border: 1px solid rgba(255,255,255,.25); }

    @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.05);} }
    @keyframes spin { to{ transform: rotate(360deg);} }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay"><div class="loading-spinner"></div></div>

  <div class="dashboard-container">
    <div class="header">
      <h1>üé≠ Dashboard Actividades Culturales Madrid</h1>
      <p>An√°lisis en tiempo real de eventos culturales y de ocio municipal - Pr√≥ximos 100 d√≠as</p>
      <div class="update-info">
        <div>
          <span class="last-update">√öltima actualizaci√≥n: <span id="lastUpdate">Cargando...</span></span>
          <span id="status" class="status">Estado: iniciando‚Ä¶</span>
        </div>
        <button class="update-btn" id="updateBtn">üîÑ Actualizar desde API Madrid</button>
      </div>
    </div>

    <div class="kpi-container" id="kpiContainer">
      <div class="kpi-card"><div class="kpi-label">Total Eventos</div><div class="kpi-value" id="totalEvents">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Eventos Gratuitos</div><div class="kpi-value" id="freeEvents">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Distritos Activos</div><div class="kpi-value" id="activeDistricts">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Eventos Hoy</div><div class="kpi-value" id="todayEvents">0</div></div>
      <div class="kpi-card"><div class="kpi-label">Para Ni√±os</div><div class="kpi-value" id="kidsEvents">0</div></div>
    </div>

    <div class="filters-container">
      <h3 style="margin-bottom: 15px;">üîç Filtros</h3>
      <div class="filters-grid">
        <div class="filter-group">
          <label for="districtFilter">Distrito</label>
          <select id="districtFilter"></select>
        </div>
        <div class="filter-group">
          <label for="typeFilter">Tipo de Evento</label>
          <select id="typeFilter"></select>
        </div>
        <div class="filter-group">
          <label for="priceFilter">Precio</label>
          <select id="priceFilter">
            <option value="">Todos</option>
            <option value="free">Solo Gratuitos</option>
            <option value="paid">Con Precio</option>
          </select>
        </div>
        <div class="filter-group">
          <label for="dateFilter">Fecha</label>
          <input type="date" id="dateFilter">
        </div>
      </div>
    </div>

    <div class="charts-container">
      <div class="chart-card"><h3>üìä Eventos por Distrito</h3><canvas id="districtChart"></canvas></div>
      <div class="chart-card"><h3>üé≠ Tipos de Eventos</h3><canvas id="typeChart"></canvas></div>
      <div class="chart-card"><h3>üìÖ Eventos por D√≠a de la Semana</h3><canvas id="weekdayChart"></canvas></div>
      <div class="chart-card"><h3>üë• Audiencia Objetivo</h3><canvas id="audienceChart"></canvas></div>
    </div>

    <div id="map"></div>

    <div class="events-table-container">
      <h3 style="margin-bottom: 20px;">üìã Pr√≥ximos Eventos</h3>
      <table class="events-table">
        <thead>
          <tr>
            <th>Fecha</th><th>T√≠tulo</th><th>Tipo</th><th>Lugar</th><th>Distrito</th><th>Precio</th>
          </tr>
        </thead>
        <tbody id="eventsTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const API_JSON = 'https://datos.madrid.es/egob/catalogo/206974-0-agenda-eventos-culturales-100.json';
    const API_CSV  = 'https://datos.madrid.es/egob/catalogo/206974-0-agenda-eventos-culturales-100.csv';

    const PROXIES = {
      allorigins: (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
      jina:       (u) => `https://r.jina.ai/http/${u.replace(/^https?:\/\//,'')}`,
      thingproxy: (u) => `https://thingproxy.freeboard.io/fetch/${u}`,
      iso_git:    (u) => `https://cors.isomorphic-git.org/${u}`
    };

    let allEvents = [];
    let filteredEvents = [];
    let charts = {};
    let map, markers = [];
    let updateInterval;

    const $ = (id) => document.getElementById(id);
    const setStatus = (msg) => { const el = $('status'); if (el) el.textContent = 'Estado: ' + msg; };
    function showNotification(message) {
      const n = document.createElement('div');
      n.style.cssText = `position: fixed; top: 20px; right: 20px; background: rgba(255,255,255,0.95); color: #333; padding: 15px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 10000;`;
      n.textContent = message; document.body.appendChild(n); setTimeout(() => n.remove(), 3500);
    }
    function stripHtml(html){ const d=document.createElement('div'); d.innerHTML=html||''; return d.textContent||d.innerText||''; }
    function prettify(s){ return (s||'').replace(/[-_]/g,' ').replace(/\s+/g,' ').trim(); }
    function toISODate(d){ if(!d) return ''; const t=new Date(d); return isNaN(t)?'':t.toISOString().split('T')[0]; }
    function numberOrNull(x){ const n=Number(x); return Number.isFinite(n)?n:null; }

    const bust = (u) => u + (u.includes("?") ? "&" : "?") + "v=" + Date.now();

    async function fetchRaw(url, as = 'json') {
      const res = await fetch(url, { cache: 'no-store', redirect: 'follow' });
      if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText} en ${url}`);
      const ct = (res.headers.get('content-type') || '').toLowerCase();
      const text = await res.text();
      if (as === 'text') return text;
      try { return JSON.parse(text); }
      catch { throw new Error(`Respuesta no es JSON v√°lido (content-type "${ct}"). Inicio: ${text.slice(0,140)}‚Ä¶`); }
    }

    function normalizeEvent(ev) {
      const loc = ev.location || {};
      const address = loc.address || {};
      const districtObj = address.district || loc.district || {};
      const districtId = (districtObj['@id'] || districtObj.id || '').toString();
      const district = districtId ? districtId.split('/').pop() : (districtObj.name || districtObj.title || address.district || '');
      const lat = loc.latitude ?? loc?.geo?.lat ?? loc?.geo?.latitude;
      const lon = loc.longitude ?? loc?.geo?.lon ?? loc?.geo?.longitude;
      const typeRaw = Array.isArray(ev['@type']) ? ev['@type'] : (ev['@type'] ? [ev['@type']] : []);
      const typeFirst = (typeRaw[0] || '').toString();
      const typeLabel = prettify((typeFirst.includes('/') ? typeFirst.split('/').pop() : typeFirst));
      let audience = 'General';
      if (Array.isArray(ev.audience)) audience = ev.audience.map(a => (a?.toString()?.split('/').pop() || a)).join(', ');
      else if (typeof ev.audience === 'string') audience = ev.audience;
      else if (ev.audience && ev.audience['@id']) audience = ev.audience['@id'].split('/').pop();
      const priceStr = (ev.price ?? '').toString().trim();
      const gratuito = (ev.free === 1 || ev.free === '1' || /gratis|gratuito/i.test(priceStr)) ? 1 : 0;
      const start = ev.dtstart || ev.startDate || ev['fecha'] || '';
      const end   = ev.dtend || ev.endDate || '';

      return {
        'ID-EVENTO': ev.id || ev['@id'] || '',
        'TITULO': ev.title || '',
        'PRECIO': priceStr,
        'GRATUITO': gratuito,
        'FECHA': start,
        'FECHA_ISO': toISODate(start),
        'FECHA-FIN': end,
        'DESCRIPCION': stripHtml(ev.description || ''),
        'NOMBRE-INSTALACION': loc.title || address['street-address'] || address['addressLocality'] || '',
        'DISTRITO-INSTALACION': prettify(district),
        'LATITUD': numberOrNull(lat),
        'LONGITUD': numberOrNull(lon),
        'TIPO': typeFirst,
        'TIPO_LABEL': typeLabel || 'Otros',
        'AUDIENCIA': audience || 'General'
      };
    }

    async function fetchFromJsonAPI() {
      setStatus('API JSON externa');
      const candidates = [
        API_JSON,
        PROXIES.allorigins(API_JSON),
        PROXIES.jina(API_JSON),
        PROXIES.thingproxy(API_JSON),
        PROXIES.iso_git(API_JSON),
      ];
      let lastErr;
      for (const url of candidates) {
        try {
          const data = await fetchRaw(bust(url), 'json');
          const graph = Array.isArray(data) ? data : data['@graph'];
          if (!Array.isArray(graph)) throw new Error('Respuesta sin @graph');
          return graph.map(normalizeEvent);
        } catch (e) {
          lastErr = e; console.warn('Fuente fall√≥:', url, e);
        }
      }
      throw lastErr || new Error('No se pudo leer ninguna fuente JSON');
    }

    async function fetchFromCsvFallback() {
      setStatus('CSV (fallback)');
      const parseCsv = (txt) => Papa.parse(txt, { header:true, dynamicTyping:true, skipEmptyLines:true, delimiter:';' }).data;
      const mapRow = (row) => ({
        'ID-EVENTO': row['ID-EVENTO'] || row['id'] || '',
        'TITULO': row['TITULO'] || row['title'] || '',
        'PRECIO': row['PRECIO'] || row['price'] || '',
        'GRATUITO': (row['GRATUITO']===1 || row['GRATUITO']==='1' || /gratis|gratuito/i.test((row['PRECIO']||'').toString())) ? 1 : 0,
        'FECHA': row['FECHA'] || row['dtstart'] || '',
        'FECHA_ISO': toISODate(row['FECHA'] || row['dtstart']),
        'FECHA-FIN': row['FECHA-FIN'] || row['dtend'] || '',
        'DESCRIPCION': row['DESCRIPCION'] || row['description'] || '',
        'NOMBRE-INSTALACION': row['NOMBRE-INSTALACION'] || row['location.title'] || row['location'] || '',
        'DISTRITO-INSTALACION': prettify(row['DISTRITO-INSTALACION'] || row['district'] || ''),
        'LATITUD': numberOrNull(row['LATITUD']),
        'LONGITUD': numberOrNull(row['LONGITUD']),
        'TIPO': row['TIPO'] || row['@type'] || '',
        'TIPO_LABEL': prettify((row['TIPO'] || '').toString().split('/').pop()),
        'AUDIENCIA': row['AUDIENCIA'] || 'General'
      });

      const candidates = [
        API_CSV,
        PROXIES.allorigins(API_CSV),
        PROXIES.jina(API_CSV),
        PROXIES.thingproxy(API_CSV),
        PROXIES.iso_git(API_CSV),
      ];

      let lastErr;
      for (const url of candidates) {
        try {
          const txt = await fetchRaw(bust(url), 'text');
          return parseCsv(txt).map(mapRow);
        } catch (e) {
          lastErr = e; console.warn('CSV fuente fall√≥:', url, e);
        }
      }
      throw lastErr || new Error('No se pudo leer ninguna fuente CSV');
    }

    function initializeFilters() {
      const districtSelect = $('districtFilter');
      const typeSelect = $('typeFilter');
      districtSelect.innerHTML = '<option value="">Todos los distritos</option>';
      typeSelect.innerHTML = '<option value="">Todos los tipos</option>';
      [...new Set(allEvents.map(e => e['DISTRITO-INSTALACION']).filter(Boolean))]
        .sort((a,b)=>a.localeCompare(b,'es')).forEach(d => {
          const opt = document.createElement('option'); opt.value = d; opt.textContent = d; districtSelect.appendChild(opt);
        });
      [...new Set(allEvents.map(e => e['TIPO_LABEL']).filter(Boolean))]
        .sort((a,b)=>a.localeCompare(b,'es')).forEach(t => {
          const opt = document.createElement('option'); opt.value = t; opt.textContent = t; typeSelect.appendChild(opt);
        });
      districtSelect.onchange = applyFilters;
      typeSelect.onchange = applyFilters;
      $('priceFilter').onchange = applyFilters;
      $('dateFilter').onchange = applyFilters;
    }

    function applyFilters() {
      const district = $('districtFilter').value;
      const type = $('typeFilter').value;
      const price = $('priceFilter').value;
      const date = $('dateFilter').value;

      filteredEvents = allEvents.filter(ev => {
        if (district && ev['DISTRITO-INSTALACION'] !== district) return false;
        if (type && ev['TIPO_LABEL'] !== type) return false;
        if (price === 'free' && ev.GRATUITO !== 1) return false;
        if (price === 'paid' && ev.GRATUITO === 1) return false;
        if (date && ev['FECHA_ISO'] && ev['FECHA_ISO'] !== date) return false;
        if (date && !ev['FECHA_ISO']) return false;
        return true;
      });

      updateKPIs(); createOrUpdateCharts(); initializeOrUpdateMap(); updateEventsTable();
    }

    function updateKPIs() {
      $('totalEvents').textContent = filteredEvents.length;
      $('freeEvents').textContent  = filteredEvents.filter(e => e.GRATUITO === 1).length;
      const districts = [...new Set(filteredEvents.map(e => e['DISTRITO-INSTALACION']).filter(Boolean))];
      $('activeDistricts').textContent = districts.length;
      const todayISO = new Date().toISOString().split('T')[0];
      $('todayEvents').textContent = filteredEvents.filter(e => e['FECHA_ISO'] === todayISO).length;
      const kidsEvents = filteredEvents.filter(e => /ni√±|infantil|famil/i.test(e.AUDIENCIA || ''));
      $('kidsEvents').textContent = kidsEvents.length;
    }

    function buildChartsData() {
      const districtCount = {};
      filteredEvents.forEach(e => { const d = e['DISTRITO-INSTALACION'] || 'Sin distrito'; districtCount[d] = (districtCount[d] || 0) + 1; });
      const topDistricts = Object.entries(districtCount).sort((a,b)=>b[1]-a[1]).slice(0,10);

      const typeCount = {};
      filteredEvents.forEach(e => { const key = e['TIPO_LABEL'] || 'Otros'; typeCount[key] = (typeCount[key] || 0) + 1; });
      const topTypes = Object.entries(typeCount).sort((a,b)=>b[1]-a[1]).slice(0,8);

      const weekdays = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
      const weekdayData = Array(7).fill(0);
      filteredEvents.forEach(e => { if (e['FECHA']) { const d = new Date(e['FECHA']); if (!isNaN(d)) weekdayData[d.getDay()]++; } });

      const audienceCount = {};
      filteredEvents.forEach(e => {
        const a = (e.AUDIENCIA || 'General').replace(/\/usuario\//g,'').replace(/,/g,', ');
        audienceCount[a] = (audienceCount[a] || 0) + 1;
      });
      const topAudience = Object.entries(audienceCount).sort((a,b)=>b[1]-a[1]).slice(0,6);

      return { topDistricts, topTypes, weekdays, weekdayData, topAudience };
    }

    function createOrUpdateCharts() {
      Object.values(charts).forEach(c => { try { c.destroy(); } catch(_){} });
      charts = {};

      const { topDistricts, topTypes, weekdays, weekdayData, topAudience } = buildChartsData();

      charts.district = new Chart($('districtChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: topDistricts.map(d=>d[0]),
          datasets: [{ label:'Eventos', data: topDistricts.map(d=>d[1]), backgroundColor:'rgba(255,215,0,0.6)', borderColor:'rgba(255,215,0,1)', borderWidth:2 }]
        },
        options: {
          responsive:true, plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:true, ticks:{color:'white'}, grid:{color:'rgba(255,255,255,0.1)'} },
                  x:{ ticks:{color:'white'}, grid:{color:'rgba(255,255,255,0.1)'} } }
        }
      });

      charts.type = new Chart($('typeChart').getContext('2d'), {
        type:'doughnut',
        data:{ labels: topTypes.map(t=>t[0]), datasets:[{ data: topTypes.map(t=>t[1]),
          backgroundColor:[
            'rgba(255,99,132,0.6)','rgba(54,162,235,0.6)','rgba(255,206,86,0.6)','rgba(75,192,192,0.6)',
            'rgba(153,102,255,0.6)','rgba(255,159,64,0.6)','rgba(231,76,60,0.6)','rgba(46,204,113,0.6)'
          ],
          borderColor:'rgba(255,255,255,0.8)', borderWidth:2 }]},
        options:{ responsive:true, plugins:{ legend:{ position:'bottom', labels:{ color:'white'} } } }
      });

      charts.weekday = new Chart($('weekdayChart').getContext('2d'), {
        type:'line',
        data:{ labels: weekdays, datasets:[{ label:'Eventos', data: weekdayData,
          backgroundColor:'rgba(75,192,192,0.2)', borderColor:'rgba(75,192,192,1)', borderWidth:3, tension:0.4, fill:true }] },
        options:{ responsive:true, plugins:{ legend:{ display:false } },
          scales:{ y:{ beginAtZero:true, ticks:{color:'white'}, grid:{color:'rgba(255,255,255,0.1)'} },
                  x:{ ticks:{color:'white'}, grid:{color:'rgba(255,255,255,0.1)'} } } }
      });

      charts.audience = new Chart($('audienceChart').getContext('2d'), {
        type:'polarArea',
        data:{ labels: topAudience.map(a=>a[0]), datasets:[{ data: topAudience.map(a=>a[1]),
          backgroundColor:[
            'rgba(255,99,132,0.5)','rgba(54,162,235,0.5)','rgba(255,206,86,0.5)',
            'rgba(75,192,192,0.5)','rgba(153,102,255,0.5)','rgba(255,159,64,0.5)'
          ],
          borderColor:'rgba(255,255,255,0.8)', borderWidth:2 }] },
        options:{ responsive:true, plugins:{ legend:{ position:'bottom', labels:{ color:'white'} } },
          scales:{ r:{ ticks:{color:'white'}, grid:{color:'rgba(255,255,255,0.1)'} } } }
      });
    }

    function initializeOrUpdateMap() {
      if (!map) {
        map = L.map('map').setView([40.4168, -3.7038], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OpenStreetMap contributors' }).addTo(map);
      }
      (markers || []).forEach(m => map.removeLayer(m)); markers = [];
      filteredEvents.forEach(e => {
        if (e.LATITUD != null && e.LONGITUD != null) {
          const m = L.marker([e.LATITUD, e.LONGITUD]).bindPopup(`
            <strong>${e.TITULO || 'Sin t√≠tulo'}</strong><br>
            ${e['NOMBRE-INSTALACION'] || 'Lugar no especificado'}<br>
            ${e['FECHA'] ? new Date(e['FECHA']).toLocaleDateString('es-ES') : 'Fecha no especificada'}<br>
            ${e.GRATUITO === 1 ? 'üÜì Gratuito' : 'üí∞ Con precio'}
          `);
          m.addTo(map); markers.push(m);
        }
      });
    }

    function updateEventsTable() {
      const tbody = $('eventsTableBody'); tbody.innerHTML = '';
      const sorted = filteredEvents.filter(e => e['FECHA']).sort((a,b)=> new Date(a['FECHA']) - new Date(b['FECHA'])).slice(0, 20);
      sorted.forEach(e => {
        const tr = document.createElement('tr');
        const tdFecha = document.createElement('td'); tdFecha.textContent = e['FECHA'] ? new Date(e['FECHA']).toLocaleDateString('es-ES') : '-'; tr.appendChild(tdFecha);
        const tdTit = document.createElement('td'); tdTit.textContent = e['TITULO'] || 'Sin t√≠tulo'; tr.appendChild(tdTit);
        const tdTipo = document.createElement('td'); tdTipo.textContent = e['TIPO_LABEL'] || '-'; tr.appendChild(tdTipo);
        const tdLugar = document.createElement('td'); tdLugar.textContent = e['NOMBRE-INSTALACION'] || '-'; tr.appendChild(tdLugar);
        const tdDist = document.createElement('td'); tdDist.textContent = e['DISTRITO-INSTALACION'] || '-'; tr.appendChild(tdDist);
        const tdPrecio = document.createElement('td'); const badge = document.createElement('span');
        badge.className = e.GRATUITO === 1 ? 'badge free' : 'badge paid'; badge.textContent = e.GRATUITO === 1 ? 'Gratuito' : 'Con precio'; tdPrecio.appendChild(badge); tr.appendChild(tdPrecio);
        tbody.appendChild(tr);
      });
    }

    async function loadDataFirstTime() {
      try {
        const data = await fetchFromJsonAPI();
        allEvents = data; setStatus('en vivo (API JSON)');
      } catch (eJson) {
        console.warn('Inicial JSON fall√≥, CSV‚Ä¶', eJson);
        try { allEvents = await fetchFromCsvFallback(); setStatus('CSV (proxy)'); }
        catch (eCsv) { allEvents = []; setStatus('sin datos'); }
      }
      filteredEvents = [...allEvents];
      initializeFilters(); updateKPIs(); createOrUpdateCharts(); initializeOrUpdateMap(); updateEventsTable();
      document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-ES');
      document.getElementById('loadingOverlay').style.display = 'none';
    }

    async function manualUpdate() {
      const btn = document.getElementById('updateBtn'); btn.classList.add('loading'); btn.disabled = true;
      try {
        try {
          const fresh = await fetchFromJsonAPI();
          allEvents = fresh; setStatus('en vivo (API JSON)'); showNotification('‚úÖ Actualizado desde API de Madrid');
        } catch (eJson) {
          console.warn('JSON fall√≥, CSV‚Ä¶', eJson);
          try {
            const dataCsv = await fetchFromCsvFallback();
            allEvents = dataCsv; setStatus('CSV (proxy)'); showNotification('‚ö†Ô∏è Actualizado desde CSV');
          } catch (eCsv) {
            setStatus('Fallo al actualizar (API/CSV)');
            showNotification('‚ùå No se pudo actualizar (API bloqueada). Mantengo datos actuales.');
            return;
          }
        }
        filteredEvents = [...allEvents];
        updateKPIs(); createOrUpdateCharts(); initializeOrUpdateMap(); updateEventsTable();
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('es-ES');
      } finally {
        btn.classList.remove('loading'); btn.disabled = false;
      }
    }

    function setupAutoUpdate() { if (updateInterval) clearInterval(updateInterval); updateInterval = setInterval(manualUpdate, 3600000); }

    document.addEventListener('DOMContentLoaded', async () => {
      document.getElementById('updateBtn').addEventListener('click', manualUpdate);
      await loadDataFirstTime();
      setupAutoUpdate();
    });
    window.addEventListener('beforeunload', () => { if (updateInterval) clearInterval(updateInterval); });
  </script>
</body>
</html>
